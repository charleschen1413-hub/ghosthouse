<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>陰森大宅 - 真人版</title>
    <style>
        /* 0. 基礎設定 */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            background: #0b0b2b; /* 深夜藍背景 */
            font-family: sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
        }

        #game-stage {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 50% 20%, #1a1a3a 0%, #0b0b2b 60%);
        }

        #ui-footer {
            flex: 0 0 100px;
            width: 100%;
            background: #05051a;
            border-top: 3px solid #2a1a3a;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 1.3rem;
            font-weight: bold;
            z-index: 50;
            padding-bottom: 10px;
            color: #fff;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        .hp { color: #ff3e3e; letter-spacing: 2px; text-shadow: 0 0 5px red; }
        .time { color: #f1c40f; text-shadow: 0 0 5px gold; }

        /* 房子容器 */
        #house-wrapper {
            width: min(95vw, calc(100vh - 120px));
            height: min(95vw, calc(100vh - 120px));
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.8));
        }

        /* --- 屋頂美化 --- */
        .roof {
            flex: 0 0 15%;
            width: 100%;
            background: linear-gradient(to bottom, #2a1a3a, #3b2b4b);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            border-bottom: 4px solid #ff9900;
            position: relative;
            z-index: 2;
        }

        /* --- 大宅本體美化 --- */
        #mansion-body {
            flex: 1;
            background-color: #2a1a3a;
            background-image: 
                linear-gradient(rgba(0,0,0,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.2) 1px, transparent 1px);
            background-size: 20px 10px;
            border: 6px solid #111;
            border-top: none; 
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            place-items: center; 
            padding: 3%;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        /* --- 窗戶美化 --- */
        .window {
            background: #1a1122;
            border: 4px solid #443355;
            border-radius: 6px;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            will-change: transform; 
            /* 預設背景設定，讓圖片居中 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 大門樣式 */
        .window.door {
            background: #332211; 
            border-color: #553322;
        }
        .window.door::before, .window.door::after {
            content: ''; position: absolute; width: 4px; height: 10px;
            background: #888; border: 1px solid #555; top: 50%; transform: translateY(-50%);
        }
        .window.door::before { left: 8px; } .window.door::after { right: 8px; }
        .window.door.open::before, .window.door.open::after { display: none; }


        /* --- 模式區分 --- */
        .window.easy-mode {
            width: 65%; height: 65%;
            transition: transform 0.3s;
        }

        .window.hard-mode {
            width: 35%; height: 35%;
            animation: hardFloat var(--anim-duration, 1s) ease-in-out infinite alternate;
        }

        @keyframes hardFloat {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(var(--mx1), var(--my1)) rotate(8deg); }
            66% { transform: translate(var(--mx2), var(--my2)) rotate(-8deg); }
            100% { transform: translate(var(--mx3), var(--my3)) rotate(0deg); }
        }

        .window.crazy-mode {
            width: 35%; height: 35%;
            border-radius: 50%;
            animation: vortexSpin var(--anim-duration, 2s) linear infinite;
        }

        @keyframes vortexSpin {
            0% { transform: rotate(0deg) translate(0, 0) scale(1); }
            25% { transform: rotate(90deg) translate(30px, 30px) scale(0.6); }
            50% { transform: rotate(180deg) translate(0, 60px) scale(1.1); }
            75% { transform: rotate(270deg) translate(-30px, 30px) scale(0.6); }
            100% { transform: rotate(360deg) translate(0, 0) scale(1); }
        }

        /* --- 狀態樣式 --- */
        /* 通用開啟狀態 (基礎發光) */
        .window.open {
            border-color: #fff !important;
            box-shadow: 0 0 20px #ffeb3b, inset 0 0 10px rgba(255,255,255,0.5) !important;
            z-index: 20;
        }
        
        /* 圖片 m.png 的窗戶 */
        .window.open-m {
            background-image: url('m.png') !important;
        }

        /* 圖片 R.png 的窗戶 */
        .window.open-r {
            background-image: url('R.png') !important;
        }

        .window.danger {
            background: linear-gradient(to bottom, #ff5555, #ff0000) !important;
            box-shadow: 0 0 20px #ff0000 !important;
            background-image: none !important; /* 危險時移除圖片 */
        }

        /* 封印動畫 */
        .seal-anim {
            animation: sealEffect 0.4s ease-out forwards !important;
        }
        @keyframes sealEffect {
            0% { transform: scale(1.4); filter: brightness(2); box-shadow: 0 0 40px #00ff00; }
            100% { transform: scale(1); filter: brightness(1); box-shadow: none; }
        }

        /* --- 鬼魂 (改用圖片 L.png) --- */
        .ghost {
            position: absolute;
            /* 改用圖片尺寸控制 */
            width: clamp(60px, 15vw, 100px);
            height: clamp(60px, 15vw, 100px);
            background-image: url('L.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%; /* 圓形鬼魂 */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); /* 鬼魂發光 */
            z-index: 30;
            cursor: pointer;
            pointer-events: auto; 
            transition: transform 0.1s;
        }
        .ghost:active { transform: scale(0.9); }

        .ghost-die {
            pointer-events: none;
            animation: ghostPop 0.4s ease-out forwards;
        }
        @keyframes ghostPop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.6; filter: hue-rotate(90deg) brightness(2); }
            100% { transform: scale(0); opacity: 0; }
        }

        /* 遮罩 */
        #overlay {
            position: absolute; inset: 0;
            background: rgba(11, 11, 43, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        
        .btn-group { 
            display: flex; flex-direction: column; gap: 15px; margin-top: 25px; width: 85%; max-width: 320px;
        }
        button {
            padding: 15px; font-size: 1.3rem;
            border: 3px solid rgba(0,0,0,0.2); border-radius: 12px; cursor: pointer;
            font-weight: bold; color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 5px 0 rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }
        button:active { transform: translateY(5px); box-shadow: none; }

        .btn-easy { background: linear-gradient(to bottom, #00b894, #008f72); }
        .btn-hard { background: linear-gradient(to bottom, #d63031, #b71c1c); }
        .btn-crazy { 
            background: linear-gradient(to bottom, #a29bfe, #6c5ce7); 
            border-color: #fff;
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); box-shadow: 0 5px 0 rgba(0,0,0,0.5), 0 0 20px #6c5ce7; } 100% { transform: scale(1); } }

        h1 { color: #ffcc00; text-shadow: 0 0 15px #ff6600, 2px 2px 0 #000; margin-bottom: 10px; font-size: 3rem; }
        .desc { color: #ccc; font-size: 1rem; margin-bottom: 25px; text-align: center; line-height: 1.5; }
        .highlight { color: #ff5555; font-weight: bold; text-shadow: 0 0 5px red; }
    </style>
</head>
<body>

<audio id="bgm" loop>
    <source src="0crocket.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<div id="app-container">
    <div id="game-stage">
        <div id="house-wrapper">
            <div class="roof"></div>
            <div id="mansion-body"></div>
        </div>
    </div>

    <div id="ui-footer">
        <div><span id="timer" class="time">120</span>s</div>
        <div id="hp-display" class="hp">❤️❤️❤️</div>
        <div class="mode-label" id="mode-display" style="font-size:0.9rem; color:#aaa;">EASY</div>
    </div>
</div>

<div id="overlay">
    <h1>陰森大宅</h1>
    <div class="desc">
        點擊亮起的照片進行封印<br>
        <span class="highlight">警告！必須點擊飄過的鬼魂(L)</span>
    </div>
    
    <div class="btn-group">
        <button class="btn-easy" onclick="startGame('easy')">EASY (一般)</button>
        <button class="btn-hard" onclick="startGame('hard')">HARD (劇烈位移)</button>
        <button class="btn-crazy" onclick="startGame('crazy')">SUPER CRAZY (漩渦)</button>
    </div>
</div>

<script>
    const mansionBody = document.getElementById('mansion-body');
    const timerEl = document.getElementById('timer');
    const hpEl = document.getElementById('hp-display');
    const overlay = document.getElementById('overlay');
    const gameStage = document.getElementById('game-stage');
    const modeDisplay = document.getElementById('mode-display');
    const bgm = document.getElementById('bgm');

    let hp = 3;
    let timeLeft = 120;
    let waveCountdown = 10;
    let waveCount = 0;
    let gameActive = false;
    let currentMode = 'easy'; 
    let windows = [];
    let gameLoop;
    let ghostInterval;

    function init() {
        mansionBody.innerHTML = '';
        windows = [];
        let modeClass = 'easy-mode';
        if (currentMode === 'hard') modeClass = 'hard-mode';
        if (currentMode === 'crazy') modeClass = 'crazy-mode';

        for (let i = 0; i < 25; i++) {
            const win = document.createElement('div');
            let extraClass = (i === 22) ? ' door' : '';
            win.className = `window ${modeClass}${extraClass}`;
            
            const handleInteract = (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                if (gameActive && win.classList.contains('open')) {
                    // 移除狀態時，也移除圖片class
                    win.classList.remove('open', 'open-m', 'open-r', 'danger');
                    triggerSealEffect(win);
                }
            };
            win.addEventListener('touchstart', handleInteract);
            win.addEventListener('mousedown', handleInteract);

            mansionBody.appendChild(win);
            windows.push(win);
        }
    }

    function triggerSealEffect(element) {
        element.classList.remove('seal-anim');
        void element.offsetWidth;
        element.classList.add('seal-anim');
    }

    function resetWindowsForNewWave() {
        let modeClass = 'easy-mode';
        if (currentMode === 'hard') modeClass = 'hard-mode';
        if (currentMode === 'crazy') modeClass = 'crazy-mode';

        windows.forEach((win, i) => {
            let extraClass = (i === 22) ? ' door' : '';
            // 重置時清除所有圖片 class
            win.className = `window ${modeClass}${extraClass}`;
            win.style.backgroundColor = '';
            
            if (currentMode === 'hard') randomizeHard(win);
            if (currentMode === 'crazy') randomizeCrazy(win);
        });

        if (currentMode !== 'easy') {
            scrambleGridOrder();
        } else {
            resetGridOrder();
        }
    }

    function randomizeHard(win) {
        for(let i=1; i<=3; i++) {
            const mx = Math.floor(Math.random() * 200) - 100;
            const my = Math.floor(Math.random() * 200) - 100;
            win.style.setProperty(`--mx${i}`, `${mx}%`);
            win.style.setProperty(`--my${i}`, `${my}%`);
        }
        const duration = 1 + Math.random() * 1.5;
        win.style.setProperty('--anim-duration', `${duration}s`);
    }

    function randomizeCrazy(win) {
        const duration = 2 + Math.random() * 3;
        win.style.setProperty('--anim-duration', `${duration}s`);
    }

    function scrambleGridOrder() {
        windows.forEach(win => win.style.order = Math.floor(Math.random() * 50));
    }
    
    function resetGridOrder() {
        windows.forEach(win => win.style.order = 0);
    }

    // --- 鬼魂系統 ---
    function startGhosts() {
        if (ghostInterval) clearInterval(ghostInterval);
        let spawnRate = currentMode === 'crazy' ? 1200 : 2000;
        
        ghostInterval = setInterval(() => {
            if(!gameActive) return;
            spawnGhost();
        }, spawnRate);
    }

    function spawnGhost() {
        const ghost = document.createElement('div');
        ghost.className = 'ghost';
        // 移除文字 Emoji，CSS 已經設定背景圖 L.png
        ghost.innerText = ''; 
        
        const direction = Math.random() > 0.5 ? 1 : -1;
        const startX = direction === 1 ? -30 : 130; 
        const endX = direction === 1 ? 130 : -30;
        const randomY = 15 + Math.random() * 70; 
        
        const baseDuration = currentMode === 'crazy' ? (1500 + Math.random() * 1000) : (3000 + Math.random() * 2000);
        const duration = baseDuration * 2; 

        ghost.style.left = startX + '%';
        ghost.style.top = randomY + '%';
        
        const killGhost = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if(ghost.classList.contains('ghost-die')) return;

            ghost.dataset.dead = "true"; 
            ghost.classList.add('ghost-die');
            setTimeout(() => ghost.remove(), 400);
        };
        
        ghost.addEventListener('touchstart', killGhost);
        ghost.addEventListener('mousedown', killGhost);

        gameStage.appendChild(ghost);

        // 鬼魂稍微旋轉飄動
        const anim = ghost.animate([
            { transform: `translateX(0) rotate(0deg)` },
            { transform: `translateX(${direction === 1 ? '160vw' : '-160vw'}) rotate(${Math.random()*60 - 30}deg)` }
        ], {
            duration: duration,
            easing: 'linear'
        });

        anim.onfinish = () => {
            if (document.body.contains(ghost) && ghost.dataset.dead !== "true") {
                takeDamage(); 
                ghost.remove();
            } else {
                if(document.body.contains(ghost)) ghost.remove();
            }
        };
    }

    function takeDamage() {
        if (!gameActive) return;
        hp--;
        updateHP();
        gameStage.style.boxShadow = 'inset 0 0 100px red';
        setTimeout(() => gameStage.style.boxShadow = 'none', 200);
        if (hp <= 0) endGame();
    }

    function startGame(mode) {
        bgm.currentTime = 0;
        bgm.play().catch(e => console.log("Audio play failed:", e));

        currentMode = mode;
        
        let color = '#00b894';
        if(mode === 'hard') color = '#d63031';
        if(mode === 'crazy') color = '#a29bfe';
        
        modeDisplay.innerHTML = `<span style="color:${color}">${mode.toUpperCase()}</span> MODE`;

        overlay.style.display = 'none';
        hp = 3; 
        timeLeft = 120; 
        waveCountdown = 10; 
        waveCount = 0; 
        gameActive = true;
        
        updateHP();
        init(); 
        
        if (currentMode !== 'easy') {
            resetWindowsForNewWave();
        }

        triggerWave(); 
        startGhosts();

        if (gameLoop) clearInterval(gameLoop);
        gameLoop = setInterval(() => {
            timeLeft--;
            waveCountdown--;
            timerEl.innerText = timeLeft;
            
            document.querySelector('.mode-label').innerHTML += ` | 下波: <span style="color:#fff">${waveCountdown}</span>`;

            if (waveCountdown === 4) checkInvasion();
            
            if (waveCountdown <= 0) {
                waveCountdown = 10;
                triggerWave();
            }

            if (timeLeft <= 0 || hp <= 0) {
                endGame();
            }
        }, 1000);
    }

    function triggerWave() {
        waveCount++;
        resetWindowsForNewWave();
        let count = Math.min(2 * waveCount, 22);
        let ids = Array.from({length: 25}, (_, i) => i).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < count; i++) {
            // 基礎開啟 class
            windows[ids[i]].classList.add('open');
            
            // 隨機分配 m.png 或 R.png
            if (Math.random() > 0.5) {
                windows[ids[i]].classList.add('open-m');
            } else {
                windows[ids[i]].classList.add('open-r');
            }
        }
    }

    function checkInvasion() {
        const openWindows = document.querySelectorAll('.window.open');
        if (openWindows.length > 0) {
            takeDamage();
            openWindows.forEach(win => win.classList.add('danger'));
        }
    }

    function updateHP() {
        hpEl.innerHTML = "❤️".repeat(Math.max(0, hp)) + "<span style='opacity:0.3'>❤️</span>".repeat(Math.max(0, 3 - hp));
    }

    function endGame() {
        bgm.pause();
        
        clearInterval(gameLoop);
        clearInterval(ghostInterval);
        gameActive = false;
        document.querySelectorAll('.ghost').forEach(g => g.remove());
        
        overlay.style.display = 'flex';
        overlay.innerHTML = `
            <h1 style="color:${hp<=0?'#ff3e3e':'#00ff00'}; text-shadow:0 0 20px ${hp<=0?'red':'green'};">
                ${hp<=0 ? '被大宅吞噬' : '成功逃脫'}
            </h1>
            <p style="font-size: 1.4rem; color:#fff; margin: 20px 0;">存活時間: <span style="color:#f1c40f">${120 - timeLeft}s</span></p>
            <p style="color:#aaa; font-size:1.1rem;">難度: ${currentMode.toUpperCase()}</p>
            <button onclick="location.reload()" style="margin-top:30px; background:linear-gradient(to bottom, #555, #333); color:#fff; padding:15px 50px; border-radius:12px; border:3px solid #222; font-size:1.3rem;">返回主選單</button>
        `;
    }
</script>
</body>
</html>