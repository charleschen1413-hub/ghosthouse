<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™°æ£®å¤§å®… - æœ€çµ‚å®Œç¾ä¿®æ­£ç‰ˆ</title>
    <style>
        /* 0. åŸºç¤è¨­å®š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            background: #0b0b2b; /* æ·±å¤œè— */
            font-family: sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
        }

        #game-stage {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        #ui-footer {
            flex: 0 0 100px;
            width: 100%;
            background: #05051a;
            border-top: 2px solid #334;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 1.3rem;
            font-weight: bold;
            z-index: 20;
            padding-bottom: 10px;
            color: #fff;
        }
        .hp { color: #ff3e3e; letter-spacing: 2px; }
        .time { color: #f1c40f; }

        /* æˆ¿å­å®¹å™¨ */
        #house-wrapper {
            width: min(95vw, calc(100vh - 120px));
            height: min(95vw, calc(100vh - 120px));
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .roof {
            flex: 0 0 15%;
            width: 100%;
            background: #1a1a1a;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            margin-bottom: -1px;
        }

        #mansion-body {
            flex: 1;
            background: #2b2b2b;
            border: 4px solid #000;
            border-top: none; 
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            place-items: center; 
            padding: 2%;
        }

        /* çª—æˆ¶åŸºç¤æ¨£å¼ */
        .window {
            background: #000;
            border: 2px solid #555;
            border-radius: 4px;
            position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
            will-change: transform; /* å„ªåŒ–ç§»å‹•æ•ˆèƒ½ */
        }

        /* --- æ¨¡å¼å€åˆ† --- */

        /* Easy: 60% å¤§å°, åƒ…ç¸®æ”¾éæ¸¡ */
        .window.easy-mode {
            width: 60%;
            height: 60%;
            transition: transform 0.3s, background-color 0.2s;
        }

        /* Hard: 30% å¤§å°, å¥—ç”¨é£„ç§»å‹•ç•« */
        .window.hard-mode {
            width: 30%;
            height: 30%;
            /* ä½¿ç”¨ CSS è®Šæ•¸å®šç¾©è»Œè·¡ 
               duration ä¹Ÿç”± JS éš¨æ©Ÿæ§åˆ¶
            */
            animation: floatAnim var(--anim-duration, 3s) ease-in-out infinite alternate;
        }

        /* é£„ç§»å‹•ç•« Keyframes */
        @keyframes floatAnim {
            0% { transform: translate(0, 0); }
            100% { transform: translate(var(--move-x, 10px), var(--move-y, 10px)); }
        }

        /* --- ç‹€æ…‹æ¨£å¼ (ä½¿ç”¨ !important ç¢ºä¿è¦†è“‹) --- */

        /* é–‹å•Ÿç‹€æ…‹ (äº®ç‡ˆ) */
        .window.open {
            background-color: #ffcc00 !important;
            border-color: #fff !important;
            box-shadow: 0 0 20px #ffcc00 !important;
            z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }

        /* æ‡²ç½°ç‹€æ…‹ (ç´…ç‡ˆ) */
        .window.danger {
            background-color: #ff0000 !important;
            box-shadow: 0 0 15px #ff0000 !important;
        }

        /* å°å°å‹•ç•« (é»æ“ŠæˆåŠŸ) */
        .seal-anim {
            animation: sealEffect 0.3s ease-out forwards !important;
        }

        @keyframes sealEffect {
            0% { transform: scale(1.5); background-color: #00ff00; }
            50% { transform: scale(0.5); box-shadow: 0 0 25px #00ff00; }
            100% { transform: scale(1); background-color: #000; }
        }

        /* é¬¼é­‚ */
        .ghost {
            position: absolute;
            font-size: clamp(2rem, 8vw, 3rem);
            opacity: 0.7;
            pointer-events: none;
            z-index: 15;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
        }

        /* é®ç½© */
        #overlay {
            position: absolute; inset: 0;
            background: rgba(11, 11, 43, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        
        .btn-group { display: flex; gap: 20px; margin-top: 30px; }
        button {
            padding: 15px 30px; font-size: 1.5rem;
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .btn-easy { background: #00b894; color: #fff; }
        .btn-hard { background: #d63031; color: #fff; }
        
        h1 { color: #fff; text-shadow: 0 0 10px #ffcc00; margin-bottom: 10px; }
        p { color: #aaa; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="game-stage">
        <div id="house-wrapper">
            <div class="roof"></div>
            <div id="mansion-body"></div>
        </div>
    </div>

    <div id="ui-footer">
        <div><span id="timer" class="time">120</span>s</div>
        <div id="hp-display" class="hp">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="mode-label" id="mode-display">EASY</div>
    </div>
</div>

<div id="overlay">
    <h1 style="font-size: 2.5rem;">å¤§å®…å°å°</h1>
    <p>Easy: å›ºå®šä½ç½®</p>
    <p>Hard: éš¨æ©Ÿç§»å‹• + é£„ç§»</p>
    <div class="btn-group">
        <button class="btn-easy" onclick="startGame('easy')">EASY</button>
        <button class="btn-hard" onclick="startGame('hard')">HARD</button>
    </div>
</div>

<script>
    const mansionBody = document.getElementById('mansion-body');
    const timerEl = document.getElementById('timer');
    const hpEl = document.getElementById('hp-display');
    const overlay = document.getElementById('overlay');
    const gameStage = document.getElementById('game-stage');
    const modeDisplay = document.getElementById('mode-display');

    let hp = 3;
    let timeLeft = 120;
    let waveCountdown = 10;
    let waveCount = 0;
    let gameActive = false;
    let currentMode = 'easy'; 
    let windows = [];
    let activeIndices = new Set();
    let gameLoop;
    let ghostInterval;

    // 1. åˆå§‹åŒ–çª—æˆ¶
    function init() {
        mansionBody.innerHTML = '';
        windows = [];
        for (let i = 0; i < 25; i++) {
            const win = document.createElement('div');
            // åˆå§‹ classï¼Œç¢ºä¿æ²’æœ‰æ®˜ç•™
            win.className = `window ${currentMode === 'easy' ? 'easy-mode' : 'hard-mode'}`;
            
            // é»æ“Šäº‹ä»¶
            const handleInteract = (e) => {
                e.preventDefault();
                // æª¢æŸ¥æ˜¯å¦æ˜¯é–‹å•Ÿç‹€æ…‹
                if (gameActive && win.classList.contains('open')) {
                    // ç§»é™¤ activeIndices ä¸­çš„ç´€éŒ„ (é›–ç„¶æˆ‘å€‘ç¾åœ¨ä¾è³´ DOM class åˆ¤æ–·ï¼Œä½†ä¿æŒæ•¸æ“šåŒæ­¥æ˜¯å¥½ç¿’æ…£)
                    // æ³¨æ„ï¼šé€™è£¡ä¸åˆªé™¤ activeIndices ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚º checkInvasion ä¾è³´ DOM class
                    
                    // ç§»é™¤ç‹€æ…‹
                    win.classList.remove('open', 'danger');
                    // è§¸ç™¼å°å°å‹•ç•«
                    triggerSealEffect(win);
                }
            };
            win.addEventListener('touchstart', handleInteract);
            win.addEventListener('mousedown', handleInteract);

            mansionBody.appendChild(win);
            windows.push(win);
        }
    }

    // æ’­æ”¾å°å°å‹•ç•«
    function triggerSealEffect(element) {
        element.classList.remove('seal-anim');
        void element.offsetWidth; // è§¸ç™¼é‡ç¹ªï¼Œä¿è­‰å‹•ç•«èƒ½é‡æ–°æ’­æ”¾
        element.classList.add('seal-anim');
    }

    // é‡ç½®æ‰€æœ‰çª—æˆ¶ (æ ¸å¿ƒä¿®å¾©é»)
    function resetWindowsForNewWave() {
        // åŸºç¤ Class
        const baseClass = `window ${currentMode === 'easy' ? 'easy-mode' : 'hard-mode'}`;
        
        windows.forEach(win => {
            // 1. æš´åŠ›é‡ç½® classNameï¼Œæ¸…é™¤ open, danger, seal-anim
            win.className = baseClass;
            
            // 2. æ¸…é™¤è¡Œå…§èƒŒæ™¯è‰² (å°å°å‹•ç•«å¯èƒ½æ®˜ç•™)
            win.style.backgroundColor = '';
            
            // 3. ç¢ºä¿å‹•ç•«æ­£ç¢º
            if (currentMode === 'hard') {
                // Hard mode: é‡æ–°éš¨æ©ŸåŒ–é£„ç§»åƒæ•¸ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´è‡ªç„¶
                randomizeFloat(win);
            } else {
                // Easy mode: æ¸…é™¤æ¨£å¼
                win.style.order = 0;
                win.style = ''; // æ¸…ç©ºæ‰€æœ‰è¡Œå…§æ¨£å¼
            }
        });

        // Hard mode: é¡å¤–æ‰“äº‚ Grid é †åº
        if (currentMode === 'hard') {
            scrambleGridOrder();
        }
    }

    // è¨­å®šéš¨æ©Ÿé£„ç§»åƒæ•¸
    function randomizeFloat(win) {
        // X å’Œ Y è»¸çš„ç§»å‹•è·é›¢ (-80% ~ 80%)
        const moveX = Math.floor(Math.random() * 160) - 80;
        const moveY = Math.floor(Math.random() * 160) - 80;
        // å‹•ç•«é€Ÿåº¦ (2s ~ 5s)
        const duration = 2 + Math.random() * 3;

        win.style.setProperty('--move-x', `${moveX}%`);
        win.style.setProperty('--move-y', `${moveY}%`);
        win.style.setProperty('--anim-duration', `${duration}s`);
    }

    // æ‰“äº‚ç¶²æ ¼ä½ç½®
    function scrambleGridOrder() {
        windows.forEach(win => {
            const randomOrder = Math.floor(Math.random() * 50);
            win.style.order = randomOrder;
        });
    }

    function startGhosts() {
        if (ghostInterval) clearInterval(ghostInterval);
        ghostInterval = setInterval(() => {
            if(!gameActive) return;
            spawnGhost();
        }, 1000);
    }

    function spawnGhost() {
        const ghost = document.createElement('div');
        ghost.className = 'ghost';
        ghost.innerText = 'ğŸ‘»';
        const direction = Math.random() > 0.5 ? 1 : -1;
        const startX = direction === 1 ? -20 : 120; 
        const randomY = 10 + Math.random() * 80; 
        const duration = 3000 + Math.random() * 3000;

        ghost.style.left = startX + '%';
        ghost.style.top = randomY + '%';
        gameStage.appendChild(ghost);

        const animation = ghost.animate([
            { transform: `translateX(0)` },
            { transform: `translateX(${direction === 1 ? '140vw' : '-140vw'})` }
        ], {
            duration: duration,
            easing: 'linear'
        });

        animation.onfinish = () => ghost.remove();
    }

    function startGame(mode) {
        currentMode = mode;
        modeDisplay.innerText = mode.toUpperCase();
        modeDisplay.style.color = mode === 'hard' ? '#d63031' : '#00b894';

        overlay.style.display = 'none';
        hp = 3; 
        timeLeft = 120; 
        waveCountdown = 10; 
        waveCount = 0; 
        gameActive = true;
        
        updateHP();
        init(); 
        
        // åˆå§‹ä½ˆå±€è¨­ç½®
        if (currentMode === 'hard') {
            windows.forEach(w => randomizeFloat(w));
            scrambleGridOrder();
        }

        triggerWave(); 
        startGhosts();

        if (gameLoop) clearInterval(gameLoop);
        gameLoop = setInterval(() => {
            timeLeft--;
            waveCountdown--;
            timerEl.innerText = timeLeft;
            
            document.querySelector('.mode-label').innerHTML = `${currentMode.toUpperCase()} <span style="color:#aaa">|</span> ä¸‹æ³¢: <span style="color:#fff">${waveCountdown}</span>`;

            if (waveCountdown === 4) checkInvasion();
            
            if (waveCountdown <= 0) {
                waveCountdown = 10;
                triggerWave();
            }

            if (timeLeft <= 0 || hp <= 0) {
                endGame();
            }
        }, 1000);
    }

    function triggerWave() {
        waveCount++;
        
        // 1. ã€é—œéµã€‘å¾¹åº•é‡ç½®æ‰€æœ‰çª—æˆ¶ï¼Œé˜²æ­¢èˆŠç‹€æ…‹æ®˜ç•™
        resetWindowsForNewWave();

        // 2. éš¨æ©Ÿé¸å–çª—æˆ¶æ‰“é–‹
        let count = Math.min(2 * waveCount, 22);
        let ids = Array.from({length: 25}, (_, i) => i).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < count; i++) {
            // å¼·åˆ¶åŠ ä¸Š open class
            windows[ids[i]].classList.add('open');
        }
    }

    function checkInvasion() {
        // æª¢æŸ¥é‚„æœ‰å¤šå°‘çª—æˆ¶æ˜¯ open çš„
        const openWindows = document.querySelectorAll('.window.open');
        if (openWindows.length > 0) {
            hp--;
            updateHP();
            openWindows.forEach(win => win.classList.add('danger'));
        }
    }

    function updateHP() {
        hpEl.innerText = "â¤ï¸".repeat(Math.max(0, hp)) + "ğŸ–¤".repeat(Math.max(0, 3 - hp));
    }

    function endGame() {
        clearInterval(gameLoop);
        clearInterval(ghostInterval);
        gameActive = false;
        document.querySelectorAll('.ghost').forEach(g => g.remove());
        
        overlay.style.display = 'flex';
        overlay.innerHTML = `
            <h1 style="color:${hp<=0?'#ff3e3e':'#00ff00'}; text-shadow:0 0 10px #000;">
                ${hp<=0 ? 'å¤±æ•—' : 'å°å°å®Œæˆ'}
            </h1>
            <p style="font-size: 1.2rem; color:#fff;">å­˜æ´»æ™‚é–“: ${120 - timeLeft}s</p>
            <button onclick="location.reload()" style="margin-top:20px; background:#fff; color:#000;">è¿”å›ä¸»é¸å–®</button>
        `;
    }
</script>
</body>
</html>